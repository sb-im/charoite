<html>

<head>
    <title>broadcast</title>
</head>

<body>
    Video<br />
    <div id="remoteVideos"></div> <br />
    Logs1<br />
    <div id="log1"></div> <br />
    Logs2<br />
    <div id="log2"></div> <br />
</body>

<script type="text/javascript">
    for (let i = 0; i < 2; i++) {
        let pc = new RTCPeerConnection({
            iceServers: [
                {
                    urls: "stun:stun.l.google.com:19302",
                }
            ]
        })
        pc.ontrack = function (event) {
            var el = document.createElement(event.track.kind)
            el.srcObject = event.streams[0]
            el.autoplay = true
            el.controls = true

            document.getElementById('remoteVideos').appendChild(el)
        }

        let log = (msg) => {
            document.getElementById(`log${i + 1}`).innerHTML += msg + "<br>";
        };

        pc.addTransceiver('video');

        pc.oniceconnectionstatechange = (e) => log(pc.iceConnectionState);

        pc.createOffer()
            .then(offer => {
                pc.setLocalDescription(offer)

                sdp = {
                    id: "fa955cc6881b4b45b49ffbf2d81e7223",
                    track_source: i,
                    sdp: offer,
                };
                return fetch(`/v1/broadcast/signal`, {
                    method: 'post',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sdp)
                })
            })
            .then(res => res.json())
            .then(res => pc.setRemoteDescription(res))
            .catch(alert)
    }
</script>

</html>
